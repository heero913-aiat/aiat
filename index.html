<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learn Your Way: AI ì¦ê°• êµê³¼ì„œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Gowun Dodum',sans-serif; background:#f0f9ff; }
    .setup-card{background:white;border-radius:24px;padding:2rem;box-shadow:0 10px 20px rgba(0,0,0,.1);}
    .cute-input{border:2px solid #e5e7eb;border-radius:12px;padding:.75rem 1rem;}
    .cute-button{border-radius:12px;font-weight:700;padding:.75rem 1rem;}
    .tab-btn.active{border-bottom:4px solid #38bdf8;font-weight:700;color:#0c4a6e;}
    .quiz-option{border:2px solid #e5e7eb;border-radius:12px;padding:.75rem;}
    .quiz-option.selected{background:#7dd3fc;border-color:#38bdf8;}
    .quiz-option.correct{background:#a7f3d0;border-color:#34d399;}
    .quiz-option.incorrect{background:#fecdd3;border-color:#fb7185;}
  </style>
</head>
<body class="text-slate-800">

  <!-- ì´ˆê¸° í™”ë©´ -->
  <div id="setup-screen" class="min-h-screen flex items-center justify-center p-6">
    <div class="setup-card w-full max-w-lg">
      <h1 class="text-3xl font-bold text-sky-700 text-center">Learn Your Way ğŸš€</h1>
      <div class="mt-6 space-y-4">
        <div><label class="block text-sm">í•™ë…„</label>
          <select id="grade-level" class="cute-input w-full">
            <option>ì´ˆë“±í•™êµ 3í•™ë…„</option><option>ì´ˆë“±í•™êµ 4í•™ë…„</option>
            <option>ì´ˆë“±í•™êµ 5í•™ë…„</option><option>ì´ˆë“±í•™êµ 6í•™ë…„</option>
          </select>
        </div>
        <div><label class="block text-sm">ê´€ì‹¬ì‚¬</label>
          <input id="interests" class="cute-input w-full" placeholder="ì˜ˆ: ê²Œì„, K-POP, ê³µë£¡">
        </div>
        <div><label class="block text-sm">í•™ìŠµ ì£¼ì œ</label>
          <input id="topic-input" class="cute-input w-full" placeholder="ì˜ˆ: ì„¸ì¢…ëŒ€ì™•, ì „ìì„">
        </div>
        <div><label class="block text-sm">AI í˜ë¥´ì†Œë‚˜</label>
          <select id="voice-persona" class="cute-input w-full">
            <option>ğŸ‘©â€ğŸ« ì¹œì ˆí•œ ì„ ìƒë‹˜</option>
            <option>ğŸ¤ í™œê¸°ì°¬ ì•„ì´ëŒ</option>
            <option>ğŸ§ ì°¨ë¶„í•œ ë¶„ì„ê°€</option>
          </select>
        </div>
      </div>
      <button id="start-learning-btn" class="mt-6 w-full bg-sky-500 hover:bg-sky-600 text-white cute-button">
        ë‚˜ë§Œì˜ êµê³¼ì„œ ë§Œë“¤ê¸°
      </button>
    </div>
  </div>

  <!-- ë¡œë”© -->
  <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white">
    <div>
      <svg class="animate-spin h-10 w-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5 0 0 5 0 12h4z"/>
      </svg>
      <p id="loading-message" class="mt-4">AIê°€ ë§ì¶¤ ìë£Œë¥¼ ìƒì„± ì¤‘...</p>
    </div>
  </div>

  <!-- ë©”ì¸ -->
  <div id="main-app-screen" class="hidden max-w-4xl mx-auto p-6">
    <header class="flex justify-between items-center mb-6">
      <h1 id="app-title" class="text-2xl font-bold text-sky-700">Learn Your Way ğŸš€</h1>
      <button id="reset-btn" class="bg-gray-200 px-4 py-2 rounded-lg">ì²˜ìŒìœ¼ë¡œ</button>
    </header>

    <nav class="flex border-b">
      <button class="tab-btn active flex-1 py-2" data-tab="text">ğŸ“– í…ìŠ¤íŠ¸</button>
      <button class="tab-btn flex-1 py-2" data-tab="slides">ğŸ–¥ï¸ ìŠ¬ë¼ì´ë“œ</button>
      <button class="tab-btn flex-1 py-2" data-tab="quiz">â“ í€´ì¦ˆ</button>
    </nav>

    <div class="mt-6">
      <div id="text-content" class="tab-content prose"></div>
      <div id="slides-content" class="tab-content hidden"></div>
      <div id="quiz-content" class="tab-content hidden"></div>
    </div>
  </div>

  <script type="module">
    const setupScreen=document.getElementById('setup-screen');
    const mainAppScreen=document.getElementById('main-app-screen');
    const loadingOverlay=document.getElementById('loading-overlay');
    const loadingMessage=document.getElementById('loading-message');
    const startBtn=document.getElementById('start-learning-btn');
    const resetBtn=document.getElementById('reset-btn');
    const tabs=document.querySelectorAll('.tab-btn');
    const textTab=document.getElementById('text-content');
    const slidesTab=document.getElementById('slides-content');
    const quizTab=document.getElementById('quiz-content');
    let userProfile={},slidesData=[],quizData=[],audios=[];

    async function callGemini(prompt, systemInstruction,isJson=false){
      const payload={contents:[{parts:[{text:prompt}]}],
        systemInstruction:{parts:[{text:systemInstruction}]}};
      if(isJson)payload.generationConfig={responseMimeType:"application/json"};
      try{
        const res=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        if(!res.ok)throw new Error("API ìš”ì²­ ì‹¤íŒ¨ "+res.status);
        const data=await res.json();
        return data?.candidates?.[0]?.content?.parts?.[0]?.text||"ì‘ë‹µ ì—†ìŒ";
      }catch(e){console.error(e);return isJson?"{}":"ì—ëŸ¬:"+e.message;}
    }

    startBtn.addEventListener("click",async()=>{
      const topic=document.getElementById("topic-input").value.trim();
      if(!topic)return alert("ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
      userProfile={grade:document.getElementById("grade-level").value,interests:document.getElementById("interests").value,topic,persona:document.getElementById("voice-persona").value};
      setupScreen.classList.add("hidden");loadingOverlay.classList.remove("hidden");
      loadingMessage.textContent=`'${topic}' ì¤€ë¹„ ì¤‘...`;

      // í…ìŠ¤íŠ¸
      const baseText=await callGemini(topic,"ì´ˆë“±í•™ìƒ ëˆˆë†’ì´ ì„¤ëª… í•œêµ­ì–´");
      textTab.innerHTML=`<h2>${topic}</h2><p>${baseText}</p>`;

      // ìŠ¬ë¼ì´ë“œ
      const slidesJson=await callGemini(topic,"3~5ê°œ í•µì‹¬ ìŠ¬ë¼ì´ë“œ JSON(title,points[]) í•œêµ­ì–´",true);
      try{slidesData=JSON.parse(slidesJson);}catch{slidesData=[];}
      renderSlides();

      // í€´ì¦ˆ
      const quizJson=await callGemini(topic,"3ë¬¸ì œ ê°ê´€ì‹ í€´ì¦ˆ JSON(question,options[],answerIndex)",true);
      try{quizData=JSON.parse(quizJson);}catch{quizData=[];}
      renderQuiz();

      loadingOverlay.classList.add("hidden");
      mainAppScreen.classList.remove("hidden");
    });

    resetBtn.addEventListener("click",()=>{mainAppScreen.classList.add("hidden");setupScreen.classList.remove("hidden");});

    tabs.forEach(tab=>{tab.addEventListener("click",()=>{tabs.forEach(t=>t.classList.remove("active"));tab.classList.add("active");document.querySelectorAll(".tab-content").forEach(c=>c.classList.add("hidden"));document.getElementById(`${tab.dataset.tab}-content`).classList.remove("hidden");});});

    function renderSlides(){if(!slidesData.length){slidesTab.innerHTML="<p>ìŠ¬ë¼ì´ë“œ ì—†ìŒ</p>";return;}
      slidesTab.innerHTML=slidesData.map((s,i)=>`
        <div class="p-4 bg-sky-50 rounded-lg mb-4">
          <h3 class="font-bold">${s.title||""}</h3>
          <ul>${(s.points||[]).map(p=>`<li>${p}</li>`).join("")}</ul>
          <button onclick="playAudio(${i})" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded">ğŸµ ë“£ê¸°</button>
        </div>`).join("");}

    function renderQuiz(){if(!quizData.length){quizTab.innerHTML="<p>í€´ì¦ˆ ì—†ìŒ</p>";return;}
      quizTab.innerHTML=quizData.map((q,i)=>`
        <div class="mb-4">
          <p class="font-semibold">${i+1}. ${q.question}</p>
          ${q.options.map((opt,j)=>`<button class="quiz-option block w-full mt-1" data-i="${i}" data-j="${j}">${opt}</button>`).join("")}
        </div>`).join("")+`<button id="submit-quiz" class="bg-emerald-500 text-white px-4 py-2 mt-4">ì±„ì í•˜ê¸°</button><div id="quiz-result"></div>`;
      quizTab.querySelectorAll(".quiz-option").forEach(btn=>btn.addEventListener("click",()=>{btn.parentElement.querySelectorAll(".quiz-option").forEach(b=>b.classList.remove("selected"));btn.classList.add("selected");}));
      quizTab.querySelector("#submit-quiz").addEventListener("click",gradeQuiz);
    }

    function gradeQuiz(){let score=0;quizData.forEach((q,i)=>{const sel=document.querySelector(`.quiz-option.selected[data-i="${i}"]`);if(sel&&parseInt(sel.dataset.j)===q.answerIndex){score++;sel.classList.add("correct");}else if(sel){sel.classList.add("incorrect");}});document.getElementById("quiz-result").textContent=`ì ìˆ˜:${score}/${quizData.length}`;}

    // ğŸµ ê°„ë‹¨í•œ ì˜¤ë””ì˜¤(TTS í‰ë‚´)
    window.playAudio=(i)=>{alert(`(TTS) ${slidesData[i]?.title} ì„¤ëª… ì˜¤ë””ì˜¤ ì¬ìƒ`);}

  </script>
</body>
</html>
