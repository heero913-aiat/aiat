<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learn Your Way: AI ì¦ê°• êµê³¼ì„œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Gowun Dodum', sans-serif;
      background-color: #f0f9ff; /* Tailwind sky-50 */
    }
    .setup-card {
      background-color: white;
      border-radius: 24px;
      box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.05),
                  0 8px 10px -6px rgb(0 0 0 / 0.05);
      border: 1px solid #e0f2fe; /* sky-100 */
      padding: 2.5rem;
    }
    .cute-input {
      border-radius: 12px;
      border-width: 2px;
      border-color: #e5e7eb;
      padding: 0.75rem 1rem;
      transition: all 0.2s ease-in-out;
    }
    .cute-input:focus {
      border-color: #fb7185;
      box-shadow: 0 0 0 3px rgb(251 113 133 / 0.2);
      outline: none;
    }
    .cute-button {
      border-radius: 12px;
      font-weight: 700;
      padding: 0.75rem 1rem;
      transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
                  0 2px 4px -2px rgb(0 0 0 / 0.1);
    }
    .cute-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
                  0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .cute-button:active {
      transform: translateY(0px);
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    }
    .tab-btn {
      border-bottom-width: 4px;
      border-color: transparent;
      color: #6b7280;
      transition: all 0.2s ease-in-out;
    }
    .tab-btn:hover {
      background-color: #f0f9ff;
      border-color: #bae6fd;
    }
    .tab-btn.active {
      border-color: #38bdf8;
      color: #0c4a6e;
      font-weight: 700;
    }
    .quiz-option {
      border-radius: 12px;
      border-width: 2px;
      box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1),
                  0 1px 2px -1px rgb(0 0 0 / 0.1);
    }
    .quiz-option:hover {
      border-color: #a5b4fc;
      background-color: #f0f9ff;
    }
    .quiz-option.selected {
      border-color: #38bdf8;
      background-color: #7dd3fc;
      color: #0c4a6e;
      font-weight: 700;
    }
    .quiz-option.correct {
      border-color: #34d399;
      background-color: #a7f3d0;
      color: #065f46;
    }
    .quiz-option.incorrect {
      border-color: #fb7185;
      background-color: #fecdd3;
      color: #9f1239;
    }
    .prose {
      font-size: 1.125rem;
      line-height: 1.8;
    }
    .prose strong {
      color: #0c4a6e;
    }
    .prose p { margin-bottom: 1rem; }
    .slide-content { min-height: 300px; }
    #loading-overlay { transition: opacity 0.3s ease-in-out; }
    .narration-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      margin-bottom: 8px;
    }
    .narration-btn:hover::after { opacity: 1; visibility: visible; }
    .narration-btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .narration-btn.ready svg { color: #3b82f6; }
    #generate-image-btn { transform: translate(-50%, 5px); }
    .illustration-wrapper .regenerate-btn {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }
    .illustration-wrapper:hover .regenerate-btn {
      opacity: 1;
    }
  </style>
</head>
<body class="text-slate-800">

  <!-- ì´ˆê¸° ì„¤ì • í™”ë©´ -->
  <div id="setup-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-lg setup-card">
      <div class="text-center">
        <h1 class="text-4xl font-bold text-sky-800">Learn Your Way ğŸš€</h1>
        <p class="mt-2 text-slate-500">AIì™€ í•¨ê»˜ ë‚˜ë§Œì˜ êµê³¼ì„œë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”.</p>
      </div>
      <div class="mt-8 space-y-6">
        <div>
          <label for="grade-level" class="block text-sm font-medium text-slate-700">í•™ë…„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</label>
          <select id="grade-level" class="mt-1 block w-full cute-input">
            <option value="ì´ˆë“±í•™êµ 1í•™ë…„">ì´ˆë“±í•™êµ 1í•™ë…„ (ë§Œ 6-7ì„¸)</option>
            <option value="ì´ˆë“±í•™êµ 2í•™ë…„">ì´ˆë“±í•™êµ 2í•™ë…„ (ë§Œ 7-8ì„¸)</option>
            <option value="ì´ˆë“±í•™êµ 3í•™ë…„" selected>ì´ˆë“±í•™êµ 3í•™ë…„ (ë§Œ 8-9ì„¸)</option>
            <option value="ì´ˆë“±í•™êµ 4í•™ë…„">ì´ˆë“±í•™êµ 4í•™ë…„ (ë§Œ 9-10ì„¸)</option>
            <option value="ì´ˆë“±í•™êµ 5í•™ë…„">ì´ˆë“±í•™êµ 5í•™ë…„ (ë§Œ 10-11ì„¸)</option>
            <option value="ì´ˆë“±í•™êµ 6í•™ë…„">ì´ˆë“±í•™êµ 6í•™ë…„ (ë§Œ 11-12ì„¸)</option>
          </select>
        </div>
        <div>
          <label for="interests" class="block text-sm font-medium text-slate-700">í•™ìƒì˜ ê´€ì‹¬ì‚¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
          <input type="text" id="interests" class="mt-1 block w-full cute-input" placeholder="ì˜ˆ: ê²Œì„, K-POP, ê³µë£¡">
        </div>
        <div>
          <label for="topic-input" class="block text-sm font-medium text-slate-700">ì˜¤ëŠ˜ í•™ìŠµí•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</label>
          <input type="text" id="topic-input" class="mt-1 block w-full cute-input" placeholder="ì˜ˆ: ì„¸ì¢…ëŒ€ì™•, ì§€êµ¬ ì˜¨ë‚œí™”, ë¶„ìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ">
        </div>
        <div>
          <label for="voice-persona" class="block text-sm font-medium text-slate-700">AI ë‚´ë ˆì´í„° í˜ë¥´ì†Œë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</label>
          <select id="voice-persona" class="mt-1 block w-full cute-input">
            <option value="ì¹œì ˆí•œ ì„ ìƒë‹˜">ğŸ‘©â€ğŸ« ì¹œì ˆí•œ ì„ ìƒë‹˜</option>
            <option value="í™œê¸°ì°¬ ì•„ì´ëŒ">ğŸ¤ í™œê¸°ì°¬ ì•„ì´ëŒ</option>
            <option value="ì°¨ë¶„í•œ ë¶„ì„ê°€">ğŸ§ ì°¨ë¶„í•œ ë¶„ì„ê°€</option>
          </select>
        </div>
      </div>
      <div class="mt-8">
        <button id="start-learning-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white cute-button text-lg">
          ë‚˜ë§Œì˜ êµê³¼ì„œ ë§Œë“¤ê¸°
        </button>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden opacity-0">
    <div class="text-center text-white">
      <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p id="loading-message" class="mt-4 text-lg">AIê°€ ë§ì¶¤í˜• í•™ìŠµ ìë£Œë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>

  <!-- ë©”ì¸ í•™ìŠµ í™”ë©´ -->
  <div id="main-app-screen" class="hidden relative w-full max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-6 flex justify-between items-center">
      <h1 id="app-title" class="text-4xl font-bold text-sky-800">Learn Your Way ğŸš€</h1>
      <div class="flex items-center space-x-4">
        <div id="preload-status" class="text-sm text-gray-500 hidden items-center space-x-2">
          <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>ë‚´ë ˆì´ì…˜ ì¤€ë¹„ ì¤‘...</span>
          <span id="preload-progress-text" class="font-medium"></span>
        </div>
        <button id="reset-btn" class="bg-slate-200 text-slate-700 hover:bg-slate-300 cute-button text-sm py-2 px-4">
          ì²˜ìŒìœ¼ë¡œ
        </button>
      </div>
    </header>

    <div class="bg-white rounded-2xl shadow-lg">
      <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
      <div class="border-b border-slate-200">
        <nav class="-mb-px flex justify-around" aria-label="Tabs">
          <button class="tab-btn active whitespace-nowrap py-4 px-1 font-bold text-sm" data-tab="immersive-text">
            ğŸ“– ëª°ì…í˜• í…ìŠ¤íŠ¸
          </button>
          <button class="tab-btn whitespace-nowrap py-4 px-1 font-bold text-sm" data-tab="slides">
            ğŸ–¥ï¸ í•µì‹¬ ìŠ¬ë¼ì´ë“œ
          </button>
          <button class="tab-btn whitespace-nowrap py-4 px-1 font-bold text-sm" data-tab="quiz">
            â“ í˜•ì„± í€´ì¦ˆ
          </button>
        </nav>
      </div>

      <!-- íƒ­ ì½˜í…ì¸  -->
      <div class="p-6 sm:p-8">
        <div id="immersive-text-content" class="tab-content prose max-w-none"></div>
        <div id="slides-content" class="tab-content hidden"></div>
        <div id="quiz-content" class="tab-content hidden"></div>
      </div>
    </div>

    <!-- ë“œë˜ê·¸ í›„ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ -->
    <button id="generate-image-btn"
      class="hidden absolute z-10 bg-sky-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-sky-600 focus:outline-none transition cute-button">
      âœ¨ ê´€ë ¨ ê·¸ë¦¼ ìƒì„±
    </button>
  </div>
  <script type="module">
    // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const setupScreen = document.getElementById('setup-screen');
    const mainAppScreen = document.getElementById('main-app-screen');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingMessage = document.getElementById('loading-message');
    const preloadStatus = document.getElementById('preload-status');
    const preloadProgressText = document.getElementById('preload-progress-text');

    const startLearningBtn = document.getElementById('start-learning-btn');
    const resetBtn = document.getElementById('reset-btn');

    const gradeLevelSelect = document.getElementById('grade-level');
    const interestsInput = document.getElementById('interests');
    const topicInput = document.getElementById('topic-input');
    const voicePersonaSelect = document.getElementById('voice-persona');
    const generateImageBtn = document.getElementById('generate-image-btn');
    const immersiveTextContainer = document.getElementById('immersive-text-content');

    const tabs = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    let userProfile = {};
    let personalizedText = "";
    let slidesData = [];
    let quizData = [];
    let preloadedAudios = [];
    let currentSelection = null;

    // -------------------------------
    // Gemini API í˜¸ì¶œ í•¨ìˆ˜
    // -------------------------------
    async function callGemini(prompt, systemInstruction, isJson = false) {
      const parts = [{ text: prompt }];

      let payload = {
        contents: [{ parts: parts }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };

      if (isJson) {
        payload.generationConfig = { responseMimeType: "application/json" };
      }

      try {
        const response = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) throw new Error("API ìš”ì²­ ì‹¤íŒ¨: " + response.status);
        const result = await response.json();

        if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
          return result.candidates[0].content.parts[0].text;
        } else {
          console.error("API ì‘ë‹µì´ ë¹„ì–´ìˆìŒ:", result);
          return isJson ? '{}' : 'ì½˜í…ì¸  ìƒì„± ì‹¤íŒ¨';
        }
      } catch (error) {
        console.error("Gemini í˜¸ì¶œ ì˜¤ë¥˜:", error);
        return isJson ? '{}' : `ì—ëŸ¬ ë°œìƒ: ${error.message}`;
      }
    }
    // -------------------------------
    // ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜
    // -------------------------------
    async function generateImage(prompt) {
      const apiKey = ""; // âš ï¸ Vercel í™˜ê²½ë³€ìˆ˜ë¡œ ì²˜ë¦¬ í•„ìš”
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
      const payload = {
        instances: [{ prompt: prompt }],
        parameters: { "sampleCount": 1 }
      };
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`Image API ì‹¤íŒ¨: ${response.status}`);
        const result = await response.json();
        if (result.predictions?.[0]?.bytesBase64Encoded) {
          return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
        }
        throw new Error("ì˜ëª»ëœ ì´ë¯¸ì§€ ë°ì´í„°");
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì˜¤ë¥˜:', error);
        return null;
      }
    }

    async function generateMotivationalImage(concept, userInterests) {
      const systemInstruction = `You are a creative art director for an educational app for elementary school students.
      Explain the concept visually with a simple, child-friendly cartoon illustration. No text, no letters, no numbers.`;
      const prompt = `Educational Concept: "${concept}"\nUser Interests: "${userInterests}"`;

      const imagePrompt = await callGemini(prompt, systemInstruction);
      const imageUrl = await generateImage(imagePrompt);
      return imageUrl || "https://placehold.co/600x400/E2E8F0/4A5568?text=Illustration+Failed";
    }

    // -------------------------------
    // ì˜¤ë””ì˜¤(TTS) ìƒì„± í•¨ìˆ˜
    // -------------------------------
    function base64ToArrayBuffer(base64) {
      const binaryString = window.atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
      return bytes.buffer;
    }

    function pcmToWav(pcmData, sampleRate) {
      const pcm16 = new Int16Array(pcmData);
      const buffer = new ArrayBuffer(44 + pcm16.length * 2);
      const view = new DataView(buffer);

      const writeString = (offset, string) => {
        for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
      };

      writeString(0, 'RIFF');
      view.setUint32(4, 36 + pcm16.length * 2, true);
      writeString(8, 'WAVE');
      writeString(12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeString(36, 'data');
      view.setUint32(40, pcm16.length * 2, true);

      for (let i = 0; i < pcm16.length; i++) view.setInt16(44 + i * 2, pcm16[i], true);
      return new Blob([view], { type: 'audio/wav' });
    }

    async function generateAudio(script, persona) {
      let voiceName = "Zephyr";
      switch (persona) {
        case 'í™œê¸°ì°¬ ì•„ì´ëŒ': voiceName = 'Puck'; break;
        case 'ì°¨ë¶„í•œ ë¶„ì„ê°€': voiceName = 'Charon'; break;
      }

      try {
        const apiKey = ""; // âš ï¸ Vercel í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬ í•„ìš”
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        const payload = {
          contents: [{ parts: [{ text: script }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
              voiceConfig: {
                prebuiltVoiceConfig: { voiceName: voiceName }
              }
            }
          }
        };
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`TTS API ì‹¤íŒ¨: ${response.status}`);
        const result = await response.json();

        const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
        const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
        if (!audioData || !mimeType) throw new Error("ì˜ëª»ëœ ì˜¤ë””ì˜¤ ë°ì´í„°");

        const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
        const pcmData = base64ToArrayBuffer(audioData);
        const wavBlob = pcmToWav(pcmData, sampleRate);
        return URL.createObjectURL(wavBlob);
      } catch (error) {
        console.error("ì˜¤ë””ì˜¤ ìƒì„± ì˜¤ë¥˜:", error);
        return null;
      }
    }
    // -------------------------------
    // í•™ìŠµ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
    // -------------------------------
    startLearningBtn.addEventListener('click', async () => {
      const topicValue = topicInput.value.trim();

      if (!topicValue) {
        alert("í•™ìŠµí•  ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      userProfile = {
        grade: gradeLevelSelect.value,
        interests: interestsInput.value || 'ë‹¤ì–‘í•œ ë¶„ì•¼',
        topic: topicValue,
        persona: voicePersonaSelect.value
      };

      preloadedAudios = []; 

      setupScreen.classList.add('hidden');
      loadingOverlay.classList.remove('hidden');
      setTimeout(() => loadingOverlay.classList.remove('opacity-0'), 10);

      loadingMessage.textContent = `AIê°€ '${userProfile.topic}'ì— ëŒ€í•œ í•™ìŠµ ìë£Œë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...`;

      // ğŸ“– ëª°ì…í˜• í…ìŠ¤íŠ¸
      const baseTextInstruction = `You are an expert curriculum developer for elementary school students.
      Create a concise, engaging educational text in Korean about the topic.`;
      personalizedText = await callGemini(userProfile.topic, baseTextInstruction);

      // ğŸ–¥ï¸ ìŠ¬ë¼ì´ë“œ
      const slideInstruction = `You are a curriculum designer. Create 3-5 short slides for Korean elementary students.
      Return JSON format: [{"title":"...", "points":["...","..."]}]`;
      const slidesJson = await callGemini(userProfile.topic, slideInstruction, true);
      try {
        slidesData = JSON.parse(slidesJson);
      } catch {
        slidesData = [];
      }

      // â“ í€´ì¦ˆ
      const quizInstruction = `You are a tutor. Create 3 simple multiple-choice quiz questions in Korean about the topic.
      Return JSON format: [{"question":"...","options":["...","...","...","..."],"answerIndex":0}]`;
      const quizJson = await callGemini(userProfile.topic, quizInstruction, true);
      try {
        quizData = JSON.parse(quizJson);
      } catch {
        quizData = [];
      }

      renderAllContent();

      loadingOverlay.classList.add('opacity-0');
      setTimeout(() => {
        loadingOverlay.classList.add('hidden');
        mainAppScreen.classList.remove('hidden');
        preloadAllNarrations();
      }, 300);
    });

    // -------------------------------
    // Reset ë²„íŠ¼
    // -------------------------------
    resetBtn.addEventListener('click', () => {
      stopNarration();
      mainAppScreen.classList.add('hidden');
      setupScreen.classList.remove('hidden');
      topicInput.value = "";
      interestsInput.value = "";
    });

    // -------------------------------
    // íƒ­ ì´ë²¤íŠ¸
    // -------------------------------
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        stopNarration();
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        tabContents.forEach(content => content.classList.add('hidden'));
        document.getElementById(`${tab.dataset.tab}-content`).classList.remove('hidden');
      });
    });

    // -------------------------------
    // ì½˜í…ì¸  ë Œë”ë§
    // -------------------------------
    function renderAllContent() {
      document.getElementById('app-title').textContent = `${userProfile.topic} - Learn Your Way ğŸš€`;
      renderImmersiveText();
      renderSlides();
      renderQuiz();
    }

    function renderImmersiveText() {
      const container = immersiveTextContainer;
      const htmlContent = personalizedText.split('\n')
        .filter(p => p.trim() !== '')
        .map(p => `<p>${p.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`)
        .join('');

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-4">${userProfile.topic} ì™„ì „ ì •ë³µí•˜ê¸°!</h2>
        <div class="text-base leading-relaxed">${htmlContent}</div>`;
    }

    // -------------------------------
    // ë“œë˜ê·¸ â†’ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼
    // -------------------------------
    document.addEventListener('mouseup', (event) => {
      if (generateImageBtn.contains(event.target)) return;
      const selection = window.getSelection();
      const selectedText = selection.toString().trim();

      if (selectedText.length > 5 && immersiveTextContainer.contains(selection.anchorNode)) {
        currentSelection = { text: selectedText, range: selection.getRangeAt(0) };
        const rect = currentSelection.range.getBoundingClientRect();
        const containerRect = mainAppScreen.getBoundingClientRect();

        generateImageBtn.style.top = `${rect.bottom - containerRect.top + 5}px`;
        generateImageBtn.style.left = `${rect.left + rect.width / 2 - containerRect.left}px`;
        generateImageBtn.classList.remove('hidden');
      } else {
        generateImageBtn.classList.add('hidden');
        currentSelection = null;
      }
    });

    generateImageBtn.addEventListener('click', async () => {
      if (!currentSelection) return;
      const { text, range } = currentSelection;
      generateImageBtn.classList.add('hidden');

      const imageUrl = await generateMotivationalImage(text, userProfile.interests);

      const imgElement = document.createElement('img');
      imgElement.src = imageUrl;
      imgElement.alt = `AI illustration for ${text}`;
      imgElement.className = 'mx-auto rounded-lg shadow-md max-w-md w-full my-6';

      const parentPara = immersiveTextContainer.querySelector('p:last-of-type');
      parentPara.insertAdjacentElement('afterend', imgElement);

      window.getSelection().removeAllRanges();
      currentSelection = null;
    });

    // -------------------------------
    // ìŠ¬ë¼ì´ë“œ ë Œë”ë§
    // -------------------------------
    function renderSlides() {
      const container = document.getElementById('slides-content');
      if (!slidesData.length) {
        container.innerHTML = `<p>ìŠ¬ë¼ì´ë“œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
        return;
      }

      let slidesHtml = slidesData.map((slide, index) => `
        <div class="slide ${index === 0 ? '' : 'hidden'}">
          <div class="relative bg-sky-50/70 p-6 rounded-lg shadow-inner slide-content flex flex-col justify-center">
            <h3 class="text-xl font-bold text-center text-sky-800 mb-4">${slide.title}</h3>
            <ul class="list-disc pl-6 space-y-2">
              ${(slide.points || []).map(point => `<li class="text-slate-700">${point}</li>`).join('')}
            </ul>
          </div>
        </div>
      `).join('');

      container.innerHTML = `
        <h2 class="text-2xl font-bold mb-4 text-center">í•µì‹¬ ìš”ì•½ ìŠ¬ë¼ì´ë“œ</h2>
        ${slidesHtml}
        <div class="flex justify-between items-center mt-4">
          <button id="prev-slide" class="bg-slate-300 text-slate-800 cute-button py-2 px-4">&lt; ì´ì „</button>
          <span id="slide-counter" class="text-sm font-medium text-slate-600">1 / ${slidesData.length}</span>
          <button id="next-slide" class="bg-sky-500 text-white cute-button py-2 px-4">ë‹¤ìŒ &gt;</button>
        </div>
      `;

      let currentSlide = 0;
      const slideElements = container.querySelectorAll('.slide');
      const prevBtn = document.getElementById('prev-slide');
      const nextBtn = document.getElementById('next-slide');
      const counter = document.getElementById('slide-counter');

      function updateSlides() {
        slideElements.forEach((s, i) => s.classList.toggle('hidden', i !== currentSlide));
        counter.textContent = `${currentSlide + 1} / ${slidesData.length}`;
        prevBtn.disabled = currentSlide === 0;
        nextBtn.disabled = currentSlide === slidesData.length - 1;
      }

      prevBtn.addEventListener('click', () => { if (currentSlide > 0) { currentSlide--; updateSlides(); } });
      nextBtn.addEventListener('click', () => { if (currentSlide < slidesData.length - 1) { currentSlide++; updateSlides(); } });
      updateSlides();
    }

    // -------------------------------
    // í€´ì¦ˆ ë Œë”ë§ & ì±„ì 
    // -------------------------------
    function renderQuiz() {
      const container = document.getElementById('quiz-content');
      if (!quizData.length) {
        container.innerHTML = `<p>í€´ì¦ˆë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
        return;
      }

      container.innerHTML = quizData.map((q, i) => `
        <div class="mb-6 quiz-item" data-index="${i}" data-answer="${q.answerIndex}">
          <p class="font-semibold mb-3 text-lg">${i + 1}. ${q.question}</p>
          ${q.options.map((opt, j) =>
            `<button class="quiz-option w-full text-left p-3 border-gray-300 bg-white mb-2" data-opt="${j}">${opt}</button>`
          ).join('')}
        </div>
      `).join('') + `<button id="submit-quiz" class="mt-4 bg-emerald-500 text-white cute-button px-6 py-2">ì±„ì í•˜ê¸°</button>
      <div id="quiz-result" class="mt-6"></div>`;

      container.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.parentElement.querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });

      document.getElementById('submit-quiz').addEventListener('click', () => {
        let score = 0;
        const items = container.querySelectorAll('.quiz-item');
        items.forEach(item => {
          const answer = parseInt(item.dataset.answer);
          const selected = item.querySelector('.quiz-option.selected');
          if (!selected) return;
          const idx = parseInt(selected.dataset.opt);
          if (idx === answer) {
            score++;
            selected.classList.add('correct');
          } else {
            selected.classList.add('incorrect');
            item.querySelectorAll('.quiz-option')[answer].classList.add('correct');
          }
        });
        document.getElementById('quiz-result').innerHTML =
          `<p class="text-center font-bold text-sky-600">ì ìˆ˜: ${score} / ${quizData.length}</p>`;
      });
    }

  </script>
</body>
</html>
